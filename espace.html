<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-store" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Espace - AlaMath</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Poppins', Arial, sans-serif;
            background: linear-gradient(to bottom right, #e9f1ff, #f9fcff);
            color: #222;
            margin: 0;
            padding: 0;
            text-align: center;
        }
        .container {
            width: 94%;
            max-width: 700px;
            margin: 38px auto;
            background: #fff;
            padding: 32px 20px 20px 20px;
            border-radius: 22px;
            box-shadow: 0 10px 24px rgba(0, 0, 0, 0.07);
            text-align: center;
            animation: fadeIn 0.8s;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(30px);}
            to { opacity: 1; transform: translateY(0);}
        }
        h1 {
            color: #004aad;
            font-size: 1.8em;
            margin-top: 0.3em;
        }
        h2 {
            color: #004aad;
            margin-bottom: 0.6em;
        }
        .logout-btn, .add-btn {
            background: #004aad;
            color: white;
            border: none;
            font-size: 1em;
            cursor: pointer;
            border-radius: 7px;
            margin: 10px 8px 0 8px;
            padding: 0.7em 1.3em;
            font-weight: bold;
            transition: all 0.3s ease;
            min-width: 150px;
        }
        .logout-btn {
            background: #ff4d4d;
        }
        .logout-btn:hover {
            background: #c00;
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(255, 77, 77, 0.3);
        }
        .add-btn:hover {
            background: #003080;
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 74, 173, 0.2);
        }
        .user-data {
            text-align: left;
            font-size: 1.13em;
            margin: 1.2em 0 1.8em 0;
            padding: 1.1em 1.3em;
            background: #f7faff;
            border-radius: 10px;
            box-shadow: 0 1px 6px #eef4fa;
            animation: fadeIn 1.2s;
            max-width: 520px;
            margin-left: auto;
            margin-right: auto;
        }
        .user-row {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            margin-bottom: 0.65em;
            gap: 0.95em;
        }
        .user-label {
            color: #004aad;
            font-weight: 600;
            min-width: 130px;
            display: inline-block;
        }
        .user-value {
            flex: 1;
            font-family: inherit;
            font-size: 1em;
            letter-spacing: 0.02em;
        }
        .masked {
            letter-spacing: 0.25em;
            font-size: 1.05em;
            vertical-align: middle;
        }
        .show-hide-btn {
            background: none;
            border: none;
            color: #004aad;
            font-size: 1em;
            cursor: pointer;
            margin-left: 7px;
            font-weight: bold;
            transition: color 0.2s;
        }
        .show-hide-btn:hover {
            color: #003080;
        }
        .cours-section {
            text-align: left;
            margin: 1.2em 0;
            background: #e7f4ff;
            border-radius: 10px;
            padding: 1.1em 1.3em;
            box-shadow: 0 1px 6px #c5e8ff36;
            animation: fadeIn 1.5s;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        .cours-title {
            font-size: 1.15em;
            font-weight: bold;
            color: #004aad;
            margin-bottom: 0.5em;
        }
        .cours-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 0.7em;
            margin-bottom: 0.8em;
            background: #fff;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px #b9e5ff36;
            table-layout: fixed;
            word-break: break-word;
        }
        .cours-table th, .cours-table td {
            border: none;
            padding: 0.75em 0.8em;
            text-align: left;
        }
        .cours-table th {
            background: #dff1ff;
            color: #004aad;
            font-weight: 600;
            font-size: 1em;
            border-bottom: 2px solid #b3dfff;
        }
        .cours-table td {
            background: #f7fcfe;
            border-bottom: 1px solid #e8f4fc;
            font-size: 0.98em;
        }
        .cours-table tr:last-child td {
            border-bottom: none;
        }
        .cours-table tr:nth-child(even) td {
            background: #f0f8fd;
        }
        .cours-table tr:hover td {
            background-color: #e0f2ff;
            transition: background-color 0.3s;
        }
        .dynamic-row {
            animation: rowFadeIn 0.7s;
        }
        @keyframes rowFadeIn {
            from { opacity: 0; }
            to { opacity: 1;}
        }
        .flex-btn-row {
            display: flex;
            justify-content: center;
            gap: 1.5em;
            margin-top: 1.5em;
        }
        /* Popup styles */
        #popupAjout {
            display:none;
            position:fixed;
            top:0;left:0;width:100vw;height:100vh;
            background:rgba(0,0,0,0.34);
            z-index:999;
            align-items:center;
            justify-content:center;
        }
        #popupAjout .popup-inner {
            background:#fff;
            padding:2em 1.3em 1.7em 1.3em;
            border-radius:14px;
            max-width:350px;
            width:96vw;
            box-shadow:0 4px 20px #0002;
            position:relative;
            border: 1px solid #d0e7ff;
            animation: popupFade 0.4s ease-out;
        }
        @keyframes popupFade {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        #popupAjout h3 {
            margin-top:0;
        }
        #popupAjoutMsg {
            color:#004aad;
            margin-top:1em;
            font-size:1em;
        }
        #popupAjoutCloseBtn {
            position:absolute;
            top:10px;
            right:16px;
            background:none;
            border:none;
            font-size:1.5em;
            cursor:pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Bienvenue sur votre espace AlaMath</h2>
        <div id="userInfo"></div>
        <div class="cours-section fade-up" id="coursSection" style="display:none;"></div>
        <div class="flex-btn-row">
            <button class="logout-btn" onclick="logout()">Déconnexion</button>
            <button class="add-btn" onclick="ajouterSeance()">Ajouter une autre matière / séance</button>
        </div>
    </div>
    <!-- Popup ajout matière/séance -->
    <div id="popupAjout">
      <div class="popup-inner">
        <button id="popupAjoutCloseBtn" onclick="closePopupAjout()">&times;</button>
        <h3>Demander une nouvelle matière / séance</h3>
        <div id="listeMatieres"></div>
        <button id="demanderBtn" style="display:none;width:100%;margin-top:1.2em;padding:0.7em 0;font-size:1.1em;background:#004aad;color:#fff;border:none;border-radius:7px;font-weight:600;cursor:pointer;">Demander</button>
        <div id="popupAjoutMsg"></div>
      </div>
    </div>
    <script>
    // Cookie helpers
    function getSessionCookie(name) {
        const nameEQ = name + "=";
        const ca = document.cookie.split(';');
        for(let i=0;i < ca.length;i++) {
            let c = ca[i];
            while (c.charAt(0)==' ') c = c.substring(1,c.length);
            if (c.indexOf(nameEQ) === 0) return decodeURIComponent(c.substring(nameEQ.length,c.length));
        }
        return null;
    }
    function eraseSessionCookie(name) {
        document.cookie = name+'=; Max-Age=-99999999; path=/; SameSite=Strict';
    }

    // Masquage/affichage clé et mot de passe
    function toggleMask(id, btnId) {
        const elem = document.getElementById(id);
        const btn = document.getElementById(btnId);
        if (elem.dataset.masked === "true") {
            elem.textContent = elem.dataset.value;
            btn.textContent = "Masquer";
            elem.dataset.masked = "false";
        } else {
            elem.textContent = "********";
            btn.textContent = "Afficher";
            elem.dataset.masked = "true";
        }
    }

    function renderUserData(user) {
        const isEleve = user.usertype && user.usertype.toLowerCase() === "eleve";
        let rows = "";

        if (isEleve) {
            // Élève : Nom tuteur, Téléphone, Email, Clé (masquée), Mot de passe (masqué), Niveau et Matière
            rows += `
                <div class="user-row"><span class="user-label">Nom du tuteur :</span><span class="user-value">${user.nom || ""}</span></div>
                <div class="user-row"><span class="user-label">Téléphone :</span><span class="user-value">${user.tel || ""}</span></div>
                <div class="user-row"><span class="user-label">Email :</span><span class="user-value">${user.email || ""}</span></div>
                <div class="user-row">
                    <span class="user-label">Clé de récupération :</span>
                    <span class="user-value">
                        <span class="masked" id="cleRecup">********</span>
                        <button class="show-hide-btn" id="btnCleRecup" type="button" onclick="toggleMask('cleRecup','btnCleRecup')">Afficher</button>
                    </span>
                </div>
                <div class="user-row">
                    <span class="user-label">Mot de passe :</span>
                    <span class="user-value">
                        <span class="masked" id="motDePasse">********</span>
                        <button class="show-hide-btn" id="btnMotDePasse" type="button" onclick="toggleMask('motDePasse','btnMotDePasse')">Afficher</button>
                    </span>
                </div>
                <div class="user-row"><span class="user-label">Cycle :</span><span class="user-value">${user.cycle || ""}</span></div>
                <div class="user-row"><span class="user-label">Niveau :</span><span class="user-value">${user.niveau || ""}</span></div>
            
            `;
        } else {
            // Professeur : Nom, Téléphone, Email, Clé (masquée), Mot de passe (masqué), Niveau et Matière
            rows += `
                <div class="user-row"><span class="user-label">Nom :</span><span class="user-value">${user.nom || ""}</span></div>
                <div class="user-row"><span class="user-label">Téléphone :</span><span class="user-value">${user.tel || ""}</span></div>
                <div class="user-row"><span class="user-label">Email :</span><span class="user-value">${user.email || ""}</span></div>
                <div class="user-row">
                    <span class="user-label">Clé de récupération :</span>
                    <span class="user-value">
                        <span class="masked" id="cleRecup">********</span>
                        <button class="show-hide-btn" id="btnCleRecup" type="button" onclick="toggleMask('cleRecup','btnCleRecup')">Afficher</button>
                    </span>
                </div>
                <div class="user-row">
                    <span class="user-label">Mot de passe :</span>
                    <span class="user-value">
                        <span class="masked" id="motDePasse">********</span>
                        <button class="show-hide-btn" id="btnMotDePasse" type="button" onclick="toggleMask('motDePasse','btnMotDePasse')">Afficher</button>
                    </span>
                </div>
                <div class="user-row"><span class="user-label">Cycle :</span><span class="user-value">${user.cycle || ""}</span></div>
                
            `;
        }
        return `<div class="user-data fade-up">${rows}</div>`;
    }

    function renderCoursSection(user) {
        const isEleve = user.usertype && user.usertype.toLowerCase() === "eleve";
        // Champs pour le tableau
        const cours = user.cours && Array.isArray(user.cours) ? user.cours : [];
        let tableHtml = "";
        if (cours.length > 0) {
            // Pour élève, colonne "Nom élève". Pour prof, colonne "Type de séance".
            const coursKeys = Object.keys(cours[0]);
            tableHtml += `<div class="cours-title">Détails du cours</div>
            <div style="overflow-x:auto">
                <table class="cours-table">
                    <tr>
                        ${coursKeys.map(col =>
                            `<th style="text-align:left;">${isEleve ? (col === "nom_eleve" ? "Nom élève" : col) :
                                                                (col === "nom_eleve" ? "Type de séance/ niveau" : col)
                            }</th>`
                        ).join('')}
                    </tr>
                    ${cours.map((coursItem, idx) => `
                        <tr class="dynamic-row">
                            ${coursKeys.map(col =>
                                `<td style="text-align:left;">${coursItem[col] || ''}</td>`
                            ).join('')}
                        </tr>
                    `).join('')}
                </table>
            </div>`;
        }
        return tableHtml;
    }

    function renderCoursSection(user) {
        const isEleve = user.usertype && user.usertype.toLowerCase() === "eleve";
        const cours = user.cours && Array.isArray(user.cours) ? user.cours : [];
        let tableHtml = "";
        if (cours.length > 0) {
            // Traductions des entêtes pour affichage utilisateur
            const headersMap = {
                nom_eleve: "Nom élève",
                matiere: "Matière",
                date_debut: "Date début",
                nbre_seance: "Nombre de séances",
                nbre_seance_impayees: "Séances impayées",
                prochaine_seance: "Prochaine séance",
                prof: "Nom du professeur",
                observation: "Observation"
            };
            const coursKeys = Object.keys(cours[0]);
            tableHtml += `<div class="cours-title">Détails des cours</div>
            <div style="overflow-x:auto">
                <table class="cours-table">
                    <tr>
                        ${coursKeys.map(col =>
                            `<th style="text-align:left;">${headersMap[col] || col}</th>`
                        ).join('')}
                        <th style="text-align:left;">Paiement</th>
                        ${isEleve ? '<th style="text-align:left;">Visa Pays</th>' : ''}
                    </tr>
                    ${cours.map((coursItem, idx) => {
                        let nbImpayees = Number(coursItem.nbre_seance_impayees || coursItem["nbre_seance_impayees"] || 0);
                        return `
                        <tr class="dynamic-row">
                            ${coursKeys.map(col =>
                                `<td style="text-align:left;">${coursItem[col] || ''}</td>`
                            ).join('')}
                            <td>
                                <button 
                                    class="add-btn" 
                                    style="min-width:90px;padding:0.5em 1em;font-size:0.98em;"
                                    ${nbImpayees > 0 ? '' : 'disabled="disabled"'}
                                    onclick="payerSeance(${idx})"
                                >Payer</button>
                            </td>
                            ${isEleve ? `<td>
                                <button 
                                    class="add-btn"
                                    style="min-width:90px;padding:0.5em 1em;font-size:0.98em;background:#0a7d2c;"
                                    onclick="visaPays(${idx})"
                                >Visa Pays</button>
                            </td>` : ''}
                        </tr>
                    `}).join('')}
                </table>
            </div>`;
        }
        return tableHtml;
    }

    // Exemple de handler (à personnaliser selon votre logique)
    function payerSeance(index) {
        alert("Paiement de la séance #" + (index+1) + " (à compléter avec votre logique de paiement)");
        // Ici, vous pouvez ouvrir un popup ou rediriger vers un module de paiement réel
    }
    function visaPays(index) {
        alert("Visa Pays demandé pour le cours #" + (index+1) + " (intégrez ici votre logique Visa/Pays)");
        // Ici, vous pouvez ouvrir un popup ou rediriger vers une action visa pays réelle
    }    function showUserInfo() {
        const userDataString = getSessionCookie('alamathUser');
        if (!userDataString) {
            window.location.href = '/'; // Redirige vers page de login si pas connecté
            return;
        }
        const user = JSON.parse(userDataString);

        // Affichage principal
        document.getElementById("userInfo").innerHTML = renderUserData(user);

        // Affichage du tableau
        const coursSection = document.getElementById("coursSection");
        coursSection.innerHTML = renderCoursSection(user);
        coursSection.style.display = "block";

        // Masquage initial clé et mot de passe, valeurs réelles en dataset pour affichage
        if (user.keyWords) {
            const elem = document.getElementById('cleRecup');
            if (elem) {
                elem.dataset.value = user.keyWords;
                elem.dataset.masked = "true";
                elem.textContent = "********";
            }
        }
        if (user.password) {
            const elem = document.getElementById('motDePasse');
            if (elem) {
                elem.dataset.value = user.password;
                elem.dataset.masked = "true";
                elem.textContent = "********";
            }
        }
    }

    showUserInfo();

    function logout() {
        eraseSessionCookie('alamathUser');
        window.location.href = '/';
    }

    // Popup Ajout Matière/Séance
    let matiereSelectionnee = "";
    function ajouterSeance() {
        const userDataString = getSessionCookie('alamathUser');
        if (!userDataString) { window.location.href = '/'; return; }
        const user = JSON.parse(userDataString);

        // Liste de matières selon le niveau
        const matieresParCycle = {
            "Maternelle": ["Découverte", "Jeux éducatifs", "Langage"],
            "Élémentaire": ["Mathématiques", "Français", "Sciences", "Histoire-Géographie", "Anglais"],
            "Collège": ["Mathématiques", "Français", "Histoire-Géographie", "SVT", "Physique-Chimie", "Anglais"],
            "Lycée": ["Mathématiques", "Français", "Philosophie", "Physique-Chimie", "SVT", "Histoire-Géographie", "Anglais"]
        };

        const niveau = user.niveau || "";
        let cycle = user.cycle || "";
        // Essayez de deviner le cycle à partir du niveau si besoin
        if (!cycle && niveau) {
            if (["Petite section","Moyenne section","Grande section"].includes(niveau)) cycle = "Maternelle";
            else if (["CP","CE1","CE2","CM1","CM2"].includes(niveau)) cycle = "Élémentaire";
            else if (["6e","5e","4e","3e"].includes(niveau)) cycle = "Collège";
            else if (["Seconde","Première","Terminale"].includes(niveau)) cycle = "Lycée";
        }

        const matieres = matieresParCycle[cycle] || [];
        let listeHtml = "";
        if(matieres.length) {
            listeHtml = `<div style="margin-bottom:1em;text-align:left;">Choisissez la matière :</div>`;
            listeHtml += matieres.map(mat => 
                `<div style="margin-bottom:0.6em;">
                    <label style="cursor:pointer;">
                        <input type="radio" name="matiereAjout" value="${mat}" onclick="selectMatiereAjout('${mat}')"> ${mat}
                    </label>
                </div>`
            ).join('');
        } else {
            listeHtml = `<div style="color:#c00;">Aucune matière disponible pour votre niveau.</div>`;
        }
        document.getElementById('listeMatieres').innerHTML = listeHtml;
        document.getElementById('demanderBtn').style.display = "none";
        document.getElementById('popupAjoutMsg').textContent = '';
        matiereSelectionnee = "";

        document.getElementById('popupAjout').style.display = "flex";
    }
    function closePopupAjout() {
        document.getElementById('popupAjout').style.display = "none";
    }
    function selectMatiereAjout(matiere) {
        matiereSelectionnee = matiere;
        document.getElementById('demanderBtn').style.display = "block";
    }
    document.getElementById('demanderBtn').onclick = function() {
        if(!matiereSelectionnee) return;
        const userDataString = getSessionCookie('alamathUser');
        if (!userDataString) { window.location.href = '/'; return; }
        const user = JSON.parse(userDataString);
        // Préparer la demande
        const dataToSend = {
            usertype: user.usertype,
            nom_eleve: user.nom_eleve || "",
            nom: user.nom || "",
            email: user.email || "",
            tel: user.tel || "",
            niveau: user.niveau || "",
            cycle: user.cycle || "",
            matiere_demande: matiereSelectionnee,
            demande_date: new Date().toISOString()
        };
        document.getElementById('popupAjoutMsg').textContent = "Envoi en cours...";
        fetch('https://api.alamath.com/demande-matiere', {
            method: "POST",
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(dataToSend)
        }).then(async res => {
            if(res.ok) {
                document.getElementById('popupAjoutMsg').style.color = "#13b813";
                document.getElementById('popupAjoutMsg').textContent = "Votre demande a bien été envoyée !";
                setTimeout(closePopupAjout, 1800);
            } else {
                let msg = "Erreur lors de l'envoi.";
                try { const data = await res.json(); if(data && data.message) msg = data.message; } catch(e){}
                document.getElementById('popupAjoutMsg').style.color = "#c00";
                document.getElementById('popupAjoutMsg').textContent = msg;
            }
        }).catch(e => {
            document.getElementById('popupAjoutMsg').style.color = "#c00";
            document.getElementById('popupAjoutMsg').textContent = "Erreur réseau : " + e;
        });
    };
    </script>
</body>
</html>
